from deepeval.test_case import LLMTestCase
from deepeval.dataset import EvaluationDataset
from deepeval import assert_test
from deepeval.metrics import (ContextualPrecisionMetric,ContextualRecallMetric,ContextualRelevancyMetric)
from deepeval import evaluate




original_dataset = [ 
    #First Test Case
    {
        "input": "What are the family planning services funded through the HHSC Family Planning Program?",
        "actual_output": "The family planning services funded through the HHSC Family Planning Program include: Health history and physical examinations, Counseling and education, Laboratory testing, Provision of a contraceptive method, Pregnancy tests, Sexually transmitted infection screenings and treatment, Referrals for additional services as needed, Immunizations, Breast and cervical cancer screening and diagnostic services, Prenatal services, Other services subject to available funding.",
        "expected_output": "The family planning services needed are Health history and physical Counseling and education Laboratory testing, Provision of a contraceptive method, Pregnancy tests, Sexually transmitted infection screenings and treatment, Referrals for additional services, as needed, Immunizations,Breast and cervical cancer screening and diagnostic services,Prenatal services, and Other services subject to available funding.",
        "context": ['Subsection 1.1, â€œFamily Planning Overviewâ€ in the Gynecological, Obstetrics, and Family Planning Title XIX Services Handbook (Vol. 2, Provider Handbooks) for more information about family planning funding sources, guidelines for family planning providers, and family planning services for undocumented aliens and legalized aliens. This section contains information about family planning services funded through the HHSC Family Planning Program funding source, including: â€¢ Health history and physical; â€¢ Counseling and education; â€¢ Laboratory testing; â€¢ Provision of a contraceptive method; â€¢ Pregnancy tests; Sexually transmitted infection screenings and treatment; â€¢ Referrals for additional services, as needed; â€¢ Immunizations; â€¢ Breast and cervical cancer screening and diagnostic services; â€¢ Prenatal services; and â€¢ Other services subject to available funding',
                    '2 CPT ONLY - COPYRIGHT 2022 AMERICAN MEDICAL ASSOCIATION. ALL RIGHTS RESERVED. Agencies that submit claims for HHSC Family Planning Program Services must have a contract with HHSC. The HHSC Family Planning Program determines client eligibility and benefits. Refer to the HHSC Family Planning Program Policy Manual for specific eligibility, services, and policy information at www.hhs.texas.gov/laws-regulations/handbooks/fpp/family-planning-program-policy-manual. Refer to: â€œSection 1: Provider Enrollment and Responsibilitiesâ€ (Vol. 1, General Information) for more information about enrollment procedures. Subsection 2.1, â€œTitle XIX Provider Enrollmentâ€ in the Gynecological, Obstetrics, and Family Planning Title XIX Services Handbook (Vol. 2, Provider Handbooks)',
                    'â€¢ Dispense family planning drugs and supplies directly to the client and bill the HHSC Family Planning Program. â€¢ Write a prescription for the client to take to a pharmacy. Family planning drugs and supplies that are dispensed directly to the client must be billed to the HHSC Family Planning Program. Only providers with an appropriate pharmacy license may be reimbursed for dispensing family planning drugs and supplies. Provider types with an appropriate pharmacy license may be reimbursed for dispensing up to a one-year supply of contraceptives in a 12-month period. Refer to: The HHSC Family Planning Program Policy Manual for more information about HHSC Family Planning Program clients may have their prescriptions filled at the clinic pharmacy. HHSC Family Planning Providers can refer to the HHSC Family Planning Policy and Procedure Manual for additional guidance on dispensing medication.'
        ],
        "retrieval_context": ['Subsection 1.1, â€œFamily Planning Overviewâ€ in the Gynecological, Obstetrics, and Family Planning Title XIX Services Handbook (Vol. 2, Provider Handbooks) for more information about family planning funding sources, guidelines for family planning providers, and family planning services for undocumented aliens and legalized aliens. This section contains information about family planning services funded through the HHSC Family Planning Program funding source, including: â€¢ Health history and physical; â€¢ Counseling and education; â€¢ Laboratory testing; â€¢ Provision of a contraceptive method; â€¢ Pregnancy tests; Sexually transmitted infection screenings and treatment; â€¢ Referrals for additional services, as needed; â€¢ Immunizations; â€¢ Breast and cervical cancer screening and diagnostic services; â€¢ Prenatal services; and â€¢ Other services subject to available funding',
                              '2 CPT ONLY - COPYRIGHT 2022 AMERICAN MEDICAL ASSOCIATION. ALL RIGHTS RESERVED. Agencies that submit claims for HHSC Family Planning Program Services must have a contract with HHSC. The HHSC Family Planning Program determines client eligibility and benefits. Refer to the HHSC Family Planning Program Policy Manual for specific eligibility, services, and policy information at www.hhs.texas.gov/laws-regulations/handbooks/fpp/family-planning-program-policy-manual. Refer to: â€œSection 1: Provider Enrollment and Responsibilitiesâ€ (Vol. 1, General Information) for more information about enrollment procedures. Subsection 2.1, â€œTitle XIX Provider Enrollmentâ€ in the Gynecological, Obstetrics, and Family Planning Title XIX Services Handbook (Vol. 2, Provider Handbooks)',
                              'â€¢ Dispense family planning drugs and supplies directly to the client and bill the HHSC Family Planning Program. â€¢ Write a prescription for the client to take to a pharmacy. Family planning drugs and supplies that are dispensed directly to the client must be billed to the HHSC Family Planning Program. Only providers with an appropriate pharmacy license may be reimbursed for dispensing family planning drugs and supplies. Provider types with an appropriate pharmacy license may be reimbursed for dispensing up to a one-year supply of contraceptives in a 12-month period. Refer to: The HHSC Family Planning Program Policy Manual for more information about HHSC Family Planning Program clients may have their prescriptions filled at the clinic pharmacy. HHSC Family Planning Providers can refer to the HHSC Family Planning Policy and Procedure Manual for additional guidance on dispensing medication.'
        ],
    },
    #Fourth Test Case
    { 
        "input": "Why do Medicaid physicians require to have authorization for non-emergency situations?",
        "actual_output": "The sources that TPR (Third Party Resources) includes for payments for Texas Medicaid are: Other health insurance including assignable indemnity contracts  Health maintenance organization (HMO) Public health programs available to clients with Medicaid such as Medicare and Tricare  Profit and nonprofit health plans?",
        "expected_output": "TPR includes payments from any of the following sources: Other health insurance including assignable indemnity contract, Health maintenance organization (HMO), Public health programs available to clients with Medicaid such as Medicare and Tricare, Profit and nonprofit health plan, Employment-related health insurance, Self-insured plans, Casualty coverage resulting from an accidental injury such as automobile or property insurance, (including no-fault insurance); No-fault automobile insurance such as personal injury protection, (PIP) and automobile medical insurance, Liability insurance, Life insurance policies, trust funds, cancer policies, or other supplemental policies, Workersâ€™ Compensation, Medical support from absent parents, Court judgments or settlements from a liability insurer, First party probate-estate recoveries, Other federal programs unless excluded by statute, Other liable third parties.",
        "context": ['According to Human Resource Code (HRC) Â§32.024 (t), a Medicaid-enrolled physician, nursing facility, health-care provider, or other responsible party is required to obtain authorization before an ambulance is used to transport a client in circumstances not involving an emergency. Providers requesting prior authorization must document whether the client is currently an inpatient in a hospital when requesting prior authorization. Prior authorization will not be approved if the provider indicates the client is currently an inpatient in a hospital, except for one-time transports immediately after the clientâ€™s discharge from the hospital. Prior authorization requests may be submitted to the TMHP Prior Authorization Department by mail, fax, or the electronic portal. Prescribing or ordering providers, dispensing providers, clientsâ€™ responsible adults, and clients may sign prior authorization forms and supporting documentation using electronic or wet signatures.',
                    'If a client’s primary coverage is private insurance and Medicaid is secondary, prior authorization is required for Medicaid reimbursement. If the primary coverage is Medicare, Medicare approves the service, and Medicaid is secondary, prior authorization is not required. TMHP will pay only the coinsurance or deductible according to current payment guidelines. If Medicare denied the service, then Medicaid prior authorization is required. TMHP must receive a prior authorization request within 30 days of the date of Medicare’s final disposition. The Medicare Remittance Advice Notice (MRAN) containing Medicare’s final disposition must accompany the prior authorization request. If the service is a Medicaid-only service, prior authorization is required within three business days of the DOS. The provider must contact the TMHP Home Health Services Prior Authorization Department within three business days of the DOS to obtain prior authorization for DME and medical supplies.'
        ],
        "retrieval_context": ['According to Human Resource Code (HRC) Â§32.024 (t), a Medicaid-enrolled physician, nursing facility, health-care provider, or other responsible party is required to obtain authorization before an ambulance is used to transport a client in circumstances not involving an emergency. Providers requesting prior authorization must document whether the client is currently an inpatient in a hospital when requesting prior authorization. Prior authorization will not be approved if the provider indicates the client is currently an inpatient in a hospital, except for one-time transports immediately after the clientâ€™s discharge from the hospital. Prior authorization requests may be submitted to the TMHP Prior Authorization Department by mail, fax, or the electronic portal. Prescribing or ordering providers, dispensing providers, clientsâ€™ responsible adults, and clients may sign prior authorization forms and supporting documentation using electronic or wet signatures.',
                              'If a client’s primary coverage is private insurance and Medicaid is secondary, prior authorization is required for Medicaid reimbursement. If the primary coverage is Medicare, Medicare approves the service, and Medicaid is secondary, prior authorization is not required. TMHP will pay only the coinsurance or deductible according to current payment guidelines. If Medicare denied the service, then Medicaid prior authorization is required. TMHP must receive a prior authorization request within 30 days of the date of Medicare’s final disposition. The Medicare Remittance Advice Notice (MRAN) containing Medicare’s final disposition must accompany the prior authorization request. If the service is a Medicaid-only service, prior authorization is required within three business days of the DOS. The provider must contact the TMHP Home Health Services Prior Authorization Department within three business days of the DOS to obtain prior authorization for DME and medical supplies.'
        ],
    },
    #Sixth Test Case
    {
        "input": "What are the following sources that TPR includes payments for Texas Medicaid?",
        "actual_output": "Medicaid physicians require authorization for non-emergency situations primarily to ensure that the treatments or services provided are medically necessary and cost-effective. This process helps manage healthcare costs and prevents unnecessary procedures, aligning with Medicaid's goal to provide efficient and appropriate care to its beneficiaries. Additionally, prior authorization serves as a checkpoint to review the appropriateness of the requested service, based on clinical criteria and patient needs, thereby safeguarding patient health and optimizing resource allocation.",
        "expected_output": "Providers requesting prior authorization must document whether the client is currently an inpatient in a hospital when requesting prior authorization. Prior authorization will not be approved if the provider indicates the client is currently an inpatient in a hospital, except for one-time transports immediately after the clientâ€™s discharge from the hospital. Prior authorization requests may be submitted to the TMHP Prior Authorization Department by mail, fax, or the electronic portal. Prescribing or ordering providers, dispensing providers, clientsâ€™ responsible adults, and clients may sign prior authorization forms and supporting documentation using electronic or wet signatures.For nonemergency ambulance transportation services rendered to a client, ambulance providers may coordinate the nonemergency ambulance prior authorization request between the requesting provider, which may include a physician, nursing facility, healthcare provider, or other responsible party. Ambulance providers may assist in providing necessary information such as their National Provider Identifier (NPI) number, fax number, and business address to the requesting provider. However, the Non-emergency Ambulance Prior Authorization Request form must be signed, dated, and submitted by the Medicaid-enrolled requesting provider, not the ambulance provider.",
        "context": ['Texas Medicaid & Healthcare Partnership Third Party Resources Unit PO Box 202948 Austin, TX 78720-2948 3 CPT ONLY - COPYRIGHT 2022 AMERICAN MEDICAL ASSOCIATION. ALL RIGHTS RESERVED. Medicaid-eligible clients may not be held responsible for billed charges that are in excess of the TPR payment for services covered by Texas Medicaid. If the TPR pays less than the Medicaid-allowable amount for covered services, the provider should submit a claim to TMHP for any additional allowable amount. 8.3 A provider who furnishes services and participates in Texas Medicaid may not refuse to furnish services to an eligible client because of a third party’s potential liability for payment of the services. TPR includes payments from any of the following sources: • Other health insurance including assignable indemnity contract • Health maintenance organization (HMO) • Public health programs available to clients with Medicaid such as Medicare and Tricare • Profit and nonprofit health plan',
                    '15 2 CPT ONLY - COPYRIGHT 2022 AMERICAN MEDICAL ASSOCIATION. ALL RIGHTS RESERVED. 8.1 Texas Medicaid Third Party Liability program recovers payments from third parties that are responsible for paying towards a medical claim for services rendered to a Texas Medicaid client. A third party resource (TPR) is the entity, individual, or other source (other than Medicaid, Medicaid managed care organizations (MCOs), Medicaid managed care dental plans, the client, non-TPR sources, or Medicare) that is legally responsible for paying the medical claims of Texas Medicaid clients. The Third Party Liability program helps reduce Medicaid costs by shifting claims expenses to third party payers.',
                    'Federal and state laws require the use of Medicaid funds for the payment of most medical services only after all reasonable measures have been made to use a client’s TPR or other insurance. To the extent allowed by federal law, a health-care service provider must seek reimbursement from available third party insurance that the provider knows about or should know about before billing Texas Medicaid. Medicaid pays only after the third party has met its legal obligation to pay (i.e., Medicaid is the payer of last resort). All claims submitted for Texas Medicaid payment for clients with other insurance coverage must reference the information, regardless of whether a copy of the explanation of benefits (EOB) from the insurance company is submitted with the claim.'
        ],
        "retrieval_context": ['Texas Medicaid & Healthcare Partnership Third Party Resources Unit PO Box 202948 Austin, TX 78720-2948 3 CPT ONLY - COPYRIGHT 2022 AMERICAN MEDICAL ASSOCIATION. ALL RIGHTS RESERVED. Medicaid-eligible clients may not be held responsible for billed charges that are in excess of the TPR payment for services covered by Texas Medicaid. If the TPR pays less than the Medicaid-allowable amount for covered services, the provider should submit a claim to TMHP for any additional allowable amount. 8.3 A provider who furnishes services and participates in Texas Medicaid may not refuse to furnish services to an eligible client because of a third party’s potential liability for payment of the services. TPR includes payments from any of the following sources: • Other health insurance including assignable indemnity contract • Health maintenance organization (HMO) • Public health programs available to clients with Medicaid such as Medicare and Tricare • Profit and nonprofit health plan',
                              '15 2 CPT ONLY - COPYRIGHT 2022 AMERICAN MEDICAL ASSOCIATION. ALL RIGHTS RESERVED. 8.1 Texas Medicaid Third Party Liability program recovers payments from third parties that are responsible for paying towards a medical claim for services rendered to a Texas Medicaid client. A third party resource (TPR) is the entity, individual, or other source (other than Medicaid, Medicaid managed care organizations (MCOs), Medicaid managed care dental plans, the client, non-TPR sources, or Medicare) that is legally responsible for paying the medical claims of Texas Medicaid clients. The Third Party Liability program helps reduce Medicaid costs by shifting claims expenses to third party payers.',
                              'Federal and state laws require the use of Medicaid funds for the payment of most medical services only after all reasonable measures have been made to use a client’s TPR or other insurance. To the extent allowed by federal law, a health-care service provider must seek reimbursement from available third party insurance that the provider knows about or should know about before billing Texas Medicaid. Medicaid pays only after the third party has met its legal obligation to pay (i.e., Medicaid is the payer of last resort). All claims submitted for Texas Medicaid payment for clients with other insurance coverage must reference the information, regardless of whether a copy of the explanation of benefits (EOB) from the insurance company is submitted with the claim.'
        ],
    },
    #Eighth Test Case
    {
        "input": "Why does a Third Party Liability support to provide payments of managed care to Texas Medicaid Clients?",
        "actual_output": "The Third Party Liability (TPL) program supports the provision of payments for managed care to Texas Medicaid clients by recovering payments from third parties that are legally responsible for paying medical claims. This process helps reduce Medicaid costs by shifting the financial responsibility for these claims to the appropriate third party payers, rather than having them solely funded by Medicaid. This ensures that Medicaid can allocate its resources more efficiently and sustainably, supporting the overall management and provision of care to its clients.",
        "expected_output": "They can limit the amount additional costs that Texas Medicaid offers to clients when relying on a TPR to provide claims when recovering any health insurance and commerical MCOs.",

        "context": ['CPT ONLY - COPYRIGHT 2022 AMERICAN MEDICAL ASSOCIATION. ALL RIGHTS RESERVED. 8.1 Texas Medicaid Third Party Liability program recovers payments from third parties that are responsible for paying towards a medical claim for services rendered to a Texas Medicaid client. A third party resource (TPR) is the entity, individual, or other source (other than Medicaid, Medicaid managed care organizations (MCOs), Medicaid managed care dental plans, the client, non-TPR sources, or Medicare) that is legally responsible for paying the medical claims of Texas Medicaid clients. The Third Party Liability program helps reduce Medicaid costs by shifting claims expenses to third party payers.',
                    'Federal and state laws require the use of Medicaid funds for the payment of most medical services only after all reasonable measures have been made to use a client’s TPR or other insurance. To the extent allowed by federal law, a health-care service provider must seek reimbursement from available third party insurance that the provider knows about or should know about before billing Texas Medicaid. Medicaid pays only after the third party has met its legal obligation to pay (i.e., Medicaid is the payer of last resort). All claims submitted for Texas Medicaid payment for clients with other insurance coverage must reference the information, regardless of whether a copy of the explanation of benefits (EOB) from the insurance company is submitted with the claim.',
                    '8.4 A non-TPR is secondary to Texas Medicaid and may only pay benefits after Texas Medicaid. Non-TPR sources include, but are not limited to, accident-only policies, managed care plans, Indigent Health Care, and Medicaid/Children’s Health Insurance Program (CHIP). The provider bills TMHP directly within 95 days from the date of service. However, if a non-TPR is billed first, TMHP must receive the claim within 95 days of the claim disposition by the other entity. Note: The provider must submit a copy of the disposition with the claim. 8.5 Inpatient and outpatient hospitals and providers enrolled in Texas Medicaid are required to inform TMHP about circumstances that may result in third party liability for health-care claims. After receiving this information, TMHP pursues reimbursement from responsible third parties.'
        ],
        "retrieval_context": ['CPT ONLY - COPYRIGHT 2022 AMERICAN MEDICAL ASSOCIATION. ALL RIGHTS RESERVED. 8.1 Texas Medicaid Third Party Liability program recovers payments from third parties that are responsible for paying towards a medical claim for services rendered to a Texas Medicaid client. A third party resource (TPR) is the entity, individual, or other source (other than Medicaid, Medicaid managed care organizations (MCOs), Medicaid managed care dental plans, the client, non-TPR sources, or Medicare) that is legally responsible for paying the medical claims of Texas Medicaid clients. The Third Party Liability program helps reduce Medicaid costs by shifting claims expenses to third party payers.',
                              'Federal and state laws require the use of Medicaid funds for the payment of most medical services only after all reasonable measures have been made to use a client’s TPR or other insurance. To the extent allowed by federal law, a health-care service provider must seek reimbursement from available third party insurance that the provider knows about or should know about before billing Texas Medicaid. Medicaid pays only after the third party has met its legal obligation to pay (i.e., Medicaid is the payer of last resort). All claims submitted for Texas Medicaid payment for clients with other insurance coverage must reference the information, regardless of whether a copy of the explanation of benefits (EOB) from the insurance company is submitted with the claim.',
                              '8.4 A non-TPR is secondary to Texas Medicaid and may only pay benefits after Texas Medicaid. Non-TPR sources include, but are not limited to, accident-only policies, managed care plans, Indigent Health Care, and Medicaid/Children’s Health Insurance Program (CHIP). The provider bills TMHP directly within 95 days from the date of service. However, if a non-TPR is billed first, TMHP must receive the claim within 95 days of the claim disposition by the other entity. Note: The provider must submit a copy of the disposition with the claim. 8.5 Inpatient and outpatient hospitals and providers enrolled in Texas Medicaid are required to inform TMHP about circumstances that may result in third party liability for health-care claims. After receiving this information, TMHP pursues reimbursement from responsible third parties.'
        ],
    },
]


contextual_precision = ContextualPrecisionMetric(model="gpt-4")
contextual_recall = ContextualRecallMetric(model="gpt-4")
contextual_relevancy = ContextualRelevancyMetric(model="gpt-4")

test_cases = []
for datapoint in original_dataset:
    input = datapoint.get("input", None)
    actual_output = datapoint.get("actual_output", None)
    expected_output = datapoint.get("expected_output", None)
    context = datapoint.get("context", None)
    retrieval_context = datapoint.get("retrieval_context", None)

    test_case = LLMTestCase(
        input=input,
        actual_output=actual_output,
        expected_output=expected_output,
        context=context,
        retrieval_context=retrieval_context
    )
    test_cases.append(test_case)

dataset = EvaluationDataset(test_cases=test_cases) #setup the test cases to evaluate
dataset.push(alias="MITA_Hyde", overwrite=True) #Push the test cases to ConfidentAI
evaluate(dataset,[contextual_precision,contextual_recall,contextual_relevancy]) #Evaluate the context metrics