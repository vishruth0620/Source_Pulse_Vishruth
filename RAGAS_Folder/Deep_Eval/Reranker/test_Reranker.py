from deepeval.test_case import LLMTestCase
from deepeval.dataset import EvaluationDataset
from deepeval import assert_test
from deepeval.metrics import (ContextualPrecisionMetric,ContextualRecallMetric,ContextualRelevancyMetric)
from deepeval import evaluate




original_dataset = [ 
    #First Test Case
    {
        "input": "What are the family planning services funded through the HHSC Family Planning Program?",
        "actual_output": "The family planning services funded through the HHSC Family Planning Program include: Health history and physical examinations, Counseling and education, Laboratory testing, Provision of a contraceptive method, Pregnancy tests, Sexually transmitted infection screenings and treatment, Referrals for additional services as needed, Immunizations, Breast and cervical cancer screening and diagnostic services, Prenatal services, Other services subject to available funding.",
        "expected_output": "The family planning services needed are Health history and physical Counseling and education Laboratory testing, Provision of a contraceptive method, Pregnancy tests, Sexually transmitted infection screenings and treatment, Referrals for additional services, as needed, Immunizations,Breast and cervical cancer screening and diagnostic services,Prenatal services, and Other services subject to available funding.",
        "context": ['An emergency behavioral health condition is defined as any condition that, in the opinion of a prudent layperson with an average knowledge of health and medicine, requires immediate intervention or medical attention regardless of the nature, without which the client would present an immediate danger to himself, or herself or others, or that renders the client incapable of controlling, knowing, or under- standing the consequences of his or her actions. Emergency transports are to be to the nearest medical facility that is equipped to provide medical care for the illness or injury of the client. An appropriate facility includes the equipment, personnel, and capability to provide the services necessary to support the required medical care.',
                    'If an emergency medical condition occurs, the lock-in restriction does not apply. The term emergency medical condition is defined as a medical condition manifesting itself by acute symptoms of sufficient severity (including severe pain), such that the absence of immediate medical attention could reasonably be expected to result in: • Placing the client’s health (or, with respect to a pregnant woman, the health of the woman or her unborn child) in serious jeopardy. Serious impairment to bodily functions. Serious dysfunction of any bodily organ or part. Important: A provider who sends in an appeal because a claim was denied with explanation of benefits (EOB) 00066 must include the performing provider NPI, not just a name or group NPI. Appeals without a performing provider NPI are denied. The NPI of the designated provider must be entered in the appropriate paper or equivalent electronic field for nonemergency inpatient and outpatient claims to be considered for reimbursement.',
                    'An emergency ambulance transport service is a benefit when the client has an emergency medical condition. An emergency medical condition is defined, according to 1 TAC §354.1111, as a medical condition (including emergency labor and delivery) manifesting itself by acute symptoms of sufficient severity (including severe pain, psychiatric disturbances, or symptoms of substance use) such that a prudent layperson with an average knowledge of health and medicine, could reasonably expect the absence of immediate medical attention to result in one of the following: • Placing the client’s health (or, with respect to a pregnant woman, the health of the woman or her unborn child) in serious jeopardy. Serious impairment to bodily functions. Serious dysfunction of any bodily organ or part.'
        ],
        "retrieval_context": ['An emergency behavioral health condition is defined as any condition that, in the opinion of a prudent layperson with an average knowledge of health and medicine, requires immediate intervention or medical attention regardless of the nature, without which the client would present an immediate danger to himself, or herself or others, or that renders the client incapable of controlling, knowing, or under- standing the consequences of his or her actions. Emergency transports are to be to the nearest medical facility that is equipped to provide medical care for the illness or injury of the client. An appropriate facility includes the equipment, personnel, and capability to provide the services necessary to support the required medical care.',
                              'If an emergency medical condition occurs, the lock-in restriction does not apply. The term emergency medical condition is defined as a medical condition manifesting itself by acute symptoms of sufficient severity (including severe pain), such that the absence of immediate medical attention could reasonably be expected to result in: • Placing the client’s health (or, with respect to a pregnant woman, the health of the woman or her unborn child) in serious jeopardy. Serious impairment to bodily functions. Serious dysfunction of any bodily organ or part. Important: A provider who sends in an appeal because a claim was denied with explanation of benefits (EOB) 00066 must include the performing provider NPI, not just a name or group NPI. Appeals without a performing provider NPI are denied. The NPI of the designated provider must be entered in the appropriate paper or equivalent electronic field for nonemergency inpatient and outpatient claims to be considered for reimbursement.',
                              'An emergency ambulance transport service is a benefit when the client has an emergency medical condition. An emergency medical condition is defined, according to 1 TAC §354.1111, as a medical condition (including emergency labor and delivery) manifesting itself by acute symptoms of sufficient severity (including severe pain, psychiatric disturbances, or symptoms of substance use) such that a prudent layperson with an average knowledge of health and medicine, could reasonably expect the absence of immediate medical attention to result in one of the following: • Placing the client’s health (or, with respect to a pregnant woman, the health of the woman or her unborn child) in serious jeopardy. Serious impairment to bodily functions. Serious dysfunction of any bodily organ or part.'
        ],
    },
    #Fourth Test Case
    { 
        "input": "Why do Medicaid physicians require to have authorization for non-emergency situations?",
        "actual_output": "The sources that TPR (Third Party Resources) includes for payments for Texas Medicaid are: Other health insurance including assignable indemnity contracts  Health maintenance organization (HMO) Public health programs available to clients with Medicaid such as Medicare and Tricare  Profit and nonprofit health plans.",
        "expected_output": "TPR includes payments from any of the following sources: Other health insurance including assignable indemnity contract, Health maintenance organization (HMO), Public health programs available to clients with Medicaid such as Medicare and Tricare, Profit and nonprofit health plan, Employment-related health insurance, Self-insured plans, Casualty coverage resulting from an accidental injury such as automobile or property insurance, (including no-fault insurance); No-fault automobile insurance such as personal injury protection, (PIP) and automobile medical insurance, Liability insurance, Life insurance policies, trust funds, cancer policies, or other supplemental policies, Workersâ€™ Compensation, Medical support from absent parents, Court judgments or settlements from a liability insurer, First party probate-estate recoveries, Other federal programs unless excluded by statute, Other liable third parties.",
        "context":['An emergency behavioral health condition is defined as any condition that, in the opinion of a prudent layperson with an average knowledge of health and medicine, requires immediate intervention or medical attention regardless of the nature, without which the client would present an immediate danger to himself, or herself or others, or that renders the client incapable of controlling, knowing, or under- standing the consequences of his or her actions. Emergency transports are to be to the nearest medical facility that is equipped to provide medical care for the illness or injury of the client. An appropriate facility includes the equipment, personnel, and capability to provide the services necessary to support the required medical care.',
                   'If an emergency medical condition occurs, the lock-in restriction does not apply. The term emergency medical condition is defined as a medical condition manifesting itself by acute symptoms of sufficient severity (including severe pain), such that the absence of immediate medical attention could reasonably be expected to result in: • Placing the client’s health (or, with respect to a pregnant woman, the health of the woman or her unborn child) in serious jeopardy. Serious impairment to bodily functions. Serious dysfunction of any bodily organ or part. Important: A provider who sends in an appeal because a claim was denied with explanation of benefits (EOB) 00066 must include the performing provider NPI, not just a name or group NPI. Appeals without a performing provider NPI are denied. The NPI of the designated provider must be entered in the appropriate paper or equivalent electronic field for nonemergency inpatient and outpatient claims to be considered for reimbursement.',
                   'An emergency ambulance transport service is a benefit when the client has an emergency medical condition. An emergency medical condition is defined, according to 1 TAC §354.1111, as a medical condition (including emergency labor and delivery) manifesting itself by acute symptoms of sufficient severity (including severe pain, psychiatric disturbances, or symptoms of substance use) such that a prudent layperson with an average knowledge of health and medicine, could reasonably expect the absence of immediate medical attention to result in one of the following: • Placing the client’s health (or, with respect to a pregnant woman, the health of the woman or her unborn child) in serious jeopardy. Serious impairment to bodily functions. Serious dysfunction of any bodily organ or part.'
        ],
        "retrieval_context": ['An emergency behavioral health condition is defined as any condition that, in the opinion of a prudent layperson with an average knowledge of health and medicine, requires immediate intervention or medical attention regardless of the nature, without which the client would present an immediate danger to himself, or herself or others, or that renders the client incapable of controlling, knowing, or under- standing the consequences of his or her actions. Emergency transports are to be to the nearest medical facility that is equipped to provide medical care for the illness or injury of the client. An appropriate facility includes the equipment, personnel, and capability to provide the services necessary to support the required medical care.',
                              'If an emergency medical condition occurs, the lock-in restriction does not apply. The term emergency medical condition is defined as a medical condition manifesting itself by acute symptoms of sufficient severity (including severe pain), such that the absence of immediate medical attention could reasonably be expected to result in: • Placing the client’s health (or, with respect to a pregnant woman, the health of the woman or her unborn child) in serious jeopardy. Serious impairment to bodily functions. Serious dysfunction of any bodily organ or part. Important: A provider who sends in an appeal because a claim was denied with explanation of benefits (EOB) 00066 must include the performing provider NPI, not just a name or group NPI. Appeals without a performing provider NPI are denied. The NPI of the designated provider must be entered in the appropriate paper or equivalent electronic field for nonemergency inpatient and outpatient claims to be considered for reimbursement.',
                              'An emergency ambulance transport service is a benefit when the client has an emergency medical condition. An emergency medical condition is defined, according to 1 TAC §354.1111, as a medical condition (including emergency labor and delivery) manifesting itself by acute symptoms of sufficient severity (including severe pain, psychiatric disturbances, or symptoms of substance use) such that a prudent layperson with an average knowledge of health and medicine, could reasonably expect the absence of immediate medical attention to result in one of the following: • Placing the client’s health (or, with respect to a pregnant woman, the health of the woman or her unborn child) in serious jeopardy. Serious impairment to bodily functions. Serious dysfunction of any bodily organ or part.'
        ],
    },
    #Sixth Test Case
    {
        "input": "What are the following sources that TPR includes payments for Texas Medicaid?",
        "actual_output": "Medicaid physicians require authorization for non-emergency situations primarily to ensure that the treatments or services provided are medically necessary and cost-effective. This process helps manage healthcare costs and prevents unnecessary procedures, aligning with Medicaid's goal to provide efficient and appropriate care to its beneficiaries. Additionally, prior authorization serves as a checkpoint to review the appropriateness of the requested service, based on clinical criteria and patient needs, thereby safeguarding patient health and optimizing resource allocation.",
        "expected_output": "Providers requesting prior authorization must document whether the client is currently an inpatient in a hospital when requesting prior authorization. Prior authorization will not be approved if the provider indicates the client is currently an inpatient in a hospital, except for one-time transports immediately after the clientâ€™s discharge from the hospital. Prior authorization requests may be submitted to the TMHP Prior Authorization Department by mail, fax, or the electronic portal. Prescribing or ordering providers, dispensing providers, clientsâ€™ responsible adults, and clients may sign prior authorization forms and supporting documentation using electronic or wet signatures.For nonemergency ambulance transportation services rendered to a client, ambulance providers may coordinate the nonemergency ambulance prior authorization request between the requesting provider, which may include a physician, nursing facility, healthcare provider, or other responsible party. Ambulance providers may assist in providing necessary information such as their National Provider Identifier (NPI) number, fax number, and business address to the requesting provider. However, the Non-emergency Ambulance Prior Authorization Request form must be signed, dated, and submitted by the Medicaid-enrolled requesting provider, not the ambulance provider.",
        "context": ['An emergency behavioral health condition is defined as any condition that, in the opinion of a prudent layperson with an average knowledge of health and medicine, requires immediate intervention or medical attention regardless of the nature, without which the client would present an immediate danger to himself, or herself or others, or that renders the client incapable of controlling, knowing, or under- standing the consequences of his or her actions. Emergency transports are to be to the nearest medical facility that is equipped to provide medical care for the illness or injury of the client. An appropriate facility includes the equipment, personnel, and capability to provide the services necessary to support the required medical care.',
                    'If an emergency medical condition occurs, the lock-in restriction does not apply. The term emergency medical condition is defined as a medical condition manifesting itself by acute symptoms of sufficient severity (including severe pain), such that the absence of immediate medical attention could reasonably be expected to result in: • Placing the client’s health (or, with respect to a pregnant woman, the health of the woman or her unborn child) in serious jeopardy. Serious impairment to bodily functions. Serious dysfunction of any bodily organ or part. Important: A provider who sends in an appeal because a claim was denied with explanation of benefits (EOB) 00066 must include the performing provider NPI, not just a name or group NPI. Appeals without a performing provider NPI are denied. The NPI of the designated provider must be entered in the appropriate paper or equivalent electronic field for nonemergency inpatient and outpatient claims to be considered for reimbursement.',
                    'An emergency ambulance transport service is a benefit when the client has an emergency medical condition. An emergency medical condition is defined, according to 1 TAC §354.1111, as a medical condition (including emergency labor and delivery) manifesting itself by acute symptoms of sufficient severity (including severe pain, psychiatric disturbances, or symptoms of substance use) such that a prudent layperson with an average knowledge of health and medicine, could reasonably expect the absence of immediate medical attention to result in one of the following: • Placing the client’s health (or, with respect to a pregnant woman, the health of the woman or her unborn child) in serious jeopardy. Serious impairment to bodily functions. Serious dysfunction of any bodily organ or part.'
        ],
        "retrieval_context": ['An emergency behavioral health condition is defined as any condition that, in the opinion of a prudent layperson with an average knowledge of health and medicine, requires immediate intervention or medical attention regardless of the nature, without which the client would present an immediate danger to himself, or herself or others, or that renders the client incapable of controlling, knowing, or under- standing the consequences of his or her actions. Emergency transports are to be to the nearest medical facility that is equipped to provide medical care for the illness or injury of the client. An appropriate facility includes the equipment, personnel, and capability to provide the services necessary to support the required medical care.',
                              'If an emergency medical condition occurs, the lock-in restriction does not apply. The term emergency medical condition is defined as a medical condition manifesting itself by acute symptoms of sufficient severity (including severe pain), such that the absence of immediate medical attention could reasonably be expected to result in: • Placing the client’s health (or, with respect to a pregnant woman, the health of the woman or her unborn child) in serious jeopardy. Serious impairment to bodily functions. Serious dysfunction of any bodily organ or part. Important: A provider who sends in an appeal because a claim was denied with explanation of benefits (EOB) 00066 must include the performing provider NPI, not just a name or group NPI. Appeals without a performing provider NPI are denied. The NPI of the designated provider must be entered in the appropriate paper or equivalent electronic field for nonemergency inpatient and outpatient claims to be considered for reimbursement.',
                              'An emergency ambulance transport service is a benefit when the client has an emergency medical condition. An emergency medical condition is defined, according to 1 TAC §354.1111, as a medical condition (including emergency labor and delivery) manifesting itself by acute symptoms of sufficient severity (including severe pain, psychiatric disturbances, or symptoms of substance use) such that a prudent layperson with an average knowledge of health and medicine, could reasonably expect the absence of immediate medical attention to result in one of the following: • Placing the client’s health (or, with respect to a pregnant woman, the health of the woman or her unborn child) in serious jeopardy. Serious impairment to bodily functions. Serious dysfunction of any bodily organ or part.'
        ],
    },
    #Eighth Test Case
    {
        "input": "Why does a Third Party Liability support to provide payments of managed care to Texas Medicaid Clients?",
        "actual_output": "The Third Party Liability (TPL) program supports the provision of payments for managed care to Texas Medicaid clients by recovering payments from third parties that are legally responsible for paying medical claims. This process helps reduce Medicaid costs by shifting the financial responsibility for these claims to the appropriate third party payers, rather than having them solely funded by Medicaid. This ensures that Medicaid can allocate its resources more efficiently and sustainably, supporting the overall management and provision of care to its clients.",
        "expected_output": "They can limit the amount additional costs that Texas Medicaid offers to clients when relying on a TPR to provide claims when recovering any health insurance and commerical MCOs.",
        "context": ['An emergency behavioral health condition is defined as any condition that, in the opinion of a prudent layperson with an average knowledge of health and medicine, requires immediate intervention or medical attention regardless of the nature, without which the client would present an immediate danger to himself, or herself or others, or that renders the client incapable of controlling, knowing, or under- standing the consequences of his or her actions. Emergency transports are to be to the nearest medical facility that is equipped to provide medical care for the illness or injury of the client. An appropriate facility includes the equipment, personnel, and capability to provide the services necessary to support the required medical care.',
                    'If an emergency medical condition occurs, the lock-in restriction does not apply. The term emergency medical condition is defined as a medical condition manifesting itself by acute symptoms of sufficient severity (including severe pain), such that the absence of immediate medical attention could reasonably be expected to result in: • Placing the client’s health (or, with respect to a pregnant woman, the health of the woman or her unborn child) in serious jeopardy. Serious impairment to bodily functions. Serious dysfunction of any bodily organ or part. Important: A provider who sends in an appeal because a claim was denied with explanation of benefits (EOB) 00066 must include the performing provider NPI, not just a name or group NPI. Appeals without a performing provider NPI are denied. The NPI of the designated provider must be entered in the appropriate paper or equivalent electronic field for nonemergency inpatient and outpatient claims to be considered for reimbursement.',
                    'An emergency ambulance transport service is a benefit when the client has an emergency medical condition. An emergency medical condition is defined, according to 1 TAC §354.1111, as a medical condition (including emergency labor and delivery) manifesting itself by acute symptoms of sufficient severity (including severe pain, psychiatric disturbances, or symptoms of substance use) such that a prudent layperson with an average knowledge of health and medicine, could reasonably expect the absence of immediate medical attention to result in one of the following: • Placing the client’s health (or, with respect to a pregnant woman, the health of the woman or her unborn child) in serious jeopardy. Serious impairment to bodily functions. Serious dysfunction of any bodily organ or part.'
        ],
        "retrieval_context": ['An emergency behavioral health condition is defined as any condition that, in the opinion of a prudent layperson with an average knowledge of health and medicine, requires immediate intervention or medical attention regardless of the nature, without which the client would present an immediate danger to himself, or herself or others, or that renders the client incapable of controlling, knowing, or under- standing the consequences of his or her actions. Emergency transports are to be to the nearest medical facility that is equipped to provide medical care for the illness or injury of the client. An appropriate facility includes the equipment, personnel, and capability to provide the services necessary to support the required medical care.',
                              'If an emergency medical condition occurs, the lock-in restriction does not apply. The term emergency medical condition is defined as a medical condition manifesting itself by acute symptoms of sufficient severity (including severe pain), such that the absence of immediate medical attention could reasonably be expected to result in: • Placing the client’s health (or, with respect to a pregnant woman, the health of the woman or her unborn child) in serious jeopardy. Serious impairment to bodily functions. Serious dysfunction of any bodily organ or part. Important: A provider who sends in an appeal because a claim was denied with explanation of benefits (EOB) 00066 must include the performing provider NPI, not just a name or group NPI. Appeals without a performing provider NPI are denied. The NPI of the designated provider must be entered in the appropriate paper or equivalent electronic field for nonemergency inpatient and outpatient claims to be considered for reimbursement.',
                              'An emergency ambulance transport service is a benefit when the client has an emergency medical condition. An emergency medical condition is defined, according to 1 TAC §354.1111, as a medical condition (including emergency labor and delivery) manifesting itself by acute symptoms of sufficient severity (including severe pain, psychiatric disturbances, or symptoms of substance use) such that a prudent layperson with an average knowledge of health and medicine, could reasonably expect the absence of immediate medical attention to result in one of the following: • Placing the client’s health (or, with respect to a pregnant woman, the health of the woman or her unborn child) in serious jeopardy. Serious impairment to bodily functions. Serious dysfunction of any bodily organ or part.'
        ],
    },
]


contextual_precision = ContextualPrecisionMetric(model="gpt-4")
contextual_recall = ContextualRecallMetric(model="gpt-4")
contextual_relevancy = ContextualRelevancyMetric(model="gpt-4")

test_cases = []
for datapoint in original_dataset:
    input = datapoint.get("input", None)
    actual_output = datapoint.get("actual_output", None)
    expected_output = datapoint.get("expected_output", None)
    context = datapoint.get("context", None)
    retrieval_context = datapoint.get("retrieval_context", None)

    test_case = LLMTestCase(
        input=input,
        actual_output=actual_output,
        expected_output=expected_output,
        context=context,
        retrieval_context=retrieval_context
    )
    test_cases.append(test_case)

dataset = EvaluationDataset(test_cases=test_cases) #setup the test cases to evaluate
dataset.push(alias="MITA_Reranker", overwrite=True) #Push the test cases to ConfidentAI
evaluate(dataset,[contextual_precision,contextual_recall,contextual_relevancy]) #Evaluate the context metrics